<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scraper ogłoszeń</title>

  <style>
    body {font-family: Arial, sans-serif;margin:20px;background:#f4f4f9;}
    input[type=text]{width:100%;padding:6px 8px;margin:6px 0 12px 0;}
    button{cursor:pointer;padding:6px 12px;border:none;border-radius:4px;background:#712f85;color:#fff;}
    button:hover{background:#5a2269}
    #statusLabel{margin-top:8px;font-style:italic}

    /* siatka wyników */
    .rezulty{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:10px}
    .group-header{grid-column:1/-1;padding:6px 4px;font-size:1.3em;font-weight:bold;color:#333}
    .phone-group{border:1px solid #ddd;border-radius:5px;padding:10px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .phone-group h3{margin:0 0 8px 0;font-size:1.05em}
    .listing{border:1px solid #e0e0e0;border-radius:5px;padding:8px;margin-top:8px;text-align:center}
    .listing img{max-width:100%;border-radius:4px;margin-bottom:6px}
    .listing h4{margin:6px 0 4px 0;font-size:1.05em}
    .listing p{margin:0;font-size:.9em;color:#666}
    .group-buttons{margin-top:6px}
    .group-buttons button{margin:2px;font-size:.8em;background:#888}
    .group-buttons button:hover{background:#666}
  </style>
</head>
<body>

  <h1>Scraper ogłoszeń</h1>

  <label for="searchUrlInput">URL wyszukiwania:</label>
  <input id="searchUrlInput" type="text"
         value="https://pl.escort.club/anonse/towarzyskie/bielsko-biala/?province=24&district=&filter_price_type=&filter_price=0%3B25000&filter_age=18%3B39&filter_weight=30%3B59&filter_height=100%3B220&filter_breasts=3%3B8&breasts_type=&hair_colors=&sexual_orientation=&searchlang=&zodiac_sign=&q=">

  <button id="fetchData">Pokaż ogłoszenia</button>
  <span id="statusLabel"></span>

  <h2>Nowości</h2>
  <div id="results-nowosci" class="rezulty"></div>

  <h2>Ulubione</h2>
  <div id="results-ulubione" class="rezulty"></div>

  <h2>Takie se</h2>
  <div id="results-takieSe" class="rezulty"></div>

  <h2>Czarna lista</h2>
  <div id="results-czarnaLista" class="rezulty"></div>

  <script>
    /* --- konfiguracja --- */
    const apiKey   = "$2a$10$H2X4RpNcSHdXokgP9SNzO.5mY8dOswBrRsGBMJOEec3kLK6tebE1C";
    const jsonBin  = "https://api.jsonbin.io/v3/b/6885d193ae596e708fbc6609";
    const proxy    = "https://cors-proxy-6b22.onrender.com/";

    /* --- dane w RAM --- */
    const phoneData = { mappings:{}, groups:{} };   // id → phone,  phone → grupa
    let cachedListings = [];                        // aktualnie pobrane elementy DOM

    const statusEl = document.getElementById("statusLabel");

    /* ------------ POBIERANIE Z jsonbin.io ------------ */
    async function loadJsonBin(){
      const r = await fetch(jsonBin+"/latest",{headers:{"X-Master-Key":apiKey}});
      const data = await r.json();
      Object.assign(phoneData, data.record);
    }
    async function saveJsonBin(){
      await fetch(jsonBin,{
        method:"PUT",
        headers:{"Content-Type":"application/json","X-Master-Key":apiKey},
        body:JSON.stringify(phoneData)
      });
    }

    /* ------------ GŁÓWNE POBRANIE OGŁOSZEŃ ------------ */
    async function fetchListings(fullReload){
      statusEl.textContent = "Start…";
      if(fullReload){
        const url = document.getElementById("searchUrlInput").value.trim();
        statusEl.textContent = "Pobieram ogłoszenia…";
        const html = await (await fetch(proxy+url)).text();
        const doc  = new DOMParser().parseFromString(html,"text/html");
        cachedListings = Array.from(doc.querySelectorAll("section.content-sec div.item-col"));
        statusEl.textContent = `Znaleziono ${cachedListings.length} ogłoszeń – pobieram numery…`;
        await enrichMissingPhones(cachedListings);
      }

      const groups = groupByPhone(cachedListings);
      fillResults(groups);

      /* podsumowanie */
      const uniquePhones = new Set(
        cachedListings
          .map(l=>phoneData.mappings[extractId(l)])
          .filter(Boolean)
      ).size;
      statusEl.textContent = `Wyświetlono ${cachedListings.length} ogłoszeń, ${uniquePhones} unikalnych numerów.`;
    }

    /* ------------ UZUPEŁNIANIE BRAKUJĄCYCH NUMERÓW ------------ */
    async function enrichMissingPhones(listings){
      for(const el of listings){
        const id = extractId(el);
        if(!phoneData.mappings[id]){
          const phone = await fetchPhone(id);
          if(phone) phoneData.mappings[id]=phone;
        }
      }
      await saveJsonBin();
    }
    async function fetchPhone(id){
      try{
        const r = await fetch(proxy+"https://pl.escort.club/includes/ajax.show-phone.php",{
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},
          body:`id=${id}`
        });
        const {phone} = await r.json();
        return phone || null;
      }catch(e){console.error("num err",e);return null;}
    }

    /* ------------ GRUPOWANIE ------------ */
    function groupByPhone(listings){
      const result = { nowosci:{}, ulubione:{}, takieSe:{}, czarnaLista:{} };
      listings.forEach(el=>{
        const id = extractId(el);
        const phone = phoneData.mappings[id] || "Nieznany";
        const grp   = phoneData.groups[phone] || "nowosci";
        if(!result[grp][phone]) result[grp][phone]=[];
        result[grp][phone].push(el);
      });
      return result;
    }

    /* ------------ WYPEŁNIANIE WYNIKÓW ------------ */
    function fillResults(groups){
      ["nowosci","ulubione","takieSe","czarnaLista"].forEach(name=>{
        const cont = document.getElementById("results-"+name);
        cont.textContent = "";                         // clear
        const phoneGroups = groups[name];
        const header = document.createElement("div");
        header.className="group-header";
        header.textContent = formatGroupName(name, Object.keys(phoneGroups).length);
        cont.appendChild(header);

        Object.entries(phoneGroups).forEach(([phone, lst])=>{
          const box = document.createElement("div"); box.className="phone-group";

          const cleaned = phone.replace("+48", "").replace(/\s+/g, "");
          const garso   = cleaned.replace(/^(\d{3})(\d{3})(\d{3})$/, "$1-$2-$3");


          box.innerHTML = `
            <h3>${phone}</h3>
            <div class="group-buttons">
              <button onclick="chgGrp('${phone}','nowosci')">Nowości</button>
              <button onclick="chgGrp('${phone}','ulubione')">Ulubione</button>
              <button onclick="chgGrp('${phone}','takieSe')">Takie se</button>
              <button onclick="chgGrp('${phone}','czarnaLista')">Czarna lista</button>
              <button onclick="copyToClipboard('${garso}')">Kopiuj</button>
            </div>`;

          lst.forEach(og=>box.appendChild(createListing(og)));
          cont.appendChild(box);
        });
      });
    }

    /* ------------ POMOCNICZE ------------ */
    function formatGroupName(key,count){
      const n={nowosci:"Nowości",ulubione:"Ulubione",takieSe:"Takie se",czarnaLista:"Czarna lista"}[key]||key;
      return `${n} (${count})`;
    }
    function extractId(el){
      return (el.querySelector("a[href*='pl.escort.club/anons']")?.href.split("/").pop()||"\"").replace(".html","");
    }
    function createListing(el){
      const t  = el.querySelector(".item-name")?.innerText.trim()||"Brak tytułu";
      const la = el.querySelector(".item-stats")?.innerText.trim()||"Brak danych";
      const img= el.querySelector("img")?.getAttribute("data-src")||"";

      const a  = el.querySelector("a[href*='pl.escort.club/anons']")?.href||"#";

      const div=document.createElement("div"); div.className="listing";
      div.innerHTML=`<img src="${img}" alt="">
        <h4>${t}</h4><p>${la}</p><a href="${a}" target="_blank">Zobacz</a>`;
      return div;
    }
    function copyToClipboard(txt){
      navigator.clipboard.writeText(`"${txt}"`);
    }
    function chgGrp(phone,grp){
      phoneData.groups[phone]=grp;
      saveJsonBin();
      fillResults(groupByPhone(cachedListings));
    }

    /* ------------ INIT ------------ */
    (async()=>{await loadJsonBin();statusEl.textContent="Dane z bazy wczytane";})();
    document.getElementById("fetchData").addEventListener("click", () => fetchListings(true));
  </script>
</body>
</html>
